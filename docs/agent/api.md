# AgentAuth Server API Documentation

This document details the API list for interaction between the AgentAuth SDK and the AgentAuth Server, including business events, browser events, and core RESTful interfaces.

## 1. Business Event List (Server to SDK)

These events are actively sent by the GenAuth Server to the SDK, and the SDK needs to subscribe to and handle these messages.

| Event Name      | Purpose                                      | Remarks                |
| :-------------- | :------------------------------------------- | :--------------------- |
| `message`       | Message event responded by the server         | Used for display or data parsing |
| `browser_event` | Browser event to be executed                 | Used for executing CDP instructions |
| `screenshot`    | Screenshot event                             | Used to determine if login or registration is needed |

**Browser Event Output Example (JSON)**

```json
{
  "actions": [
    {"method": "navigate", "value": "https://www.facebook.com"},
    {"method": "wait", "selector": "#kw", "options": {"timeout": "5s"}},
    {"method": "insertText", "selector": "#kw", "value": "AI"},
    {"method": "click", "selector": "#su"}
  ]
}
```

## 2. Browser Event List (CDP Instructions, carried by `browser_event`)

These are browser automation instructions generated by the GenAuth Server. The SDK receives them via the `browser_event` event and executes them using `chromedp` or similar tools.

| Event Name   | Purpose                                   |
| :----------- | :---------------------------------------- |
| `navigate`   | Navigate to a web page address            |
| `click`      | Click a menu or button                    |
| `wait`       | Wait for an element to load, requires custom code handling |
| `insertText` | Input data into an element                |
| `scroll`     | Mouse scroll, up or down                  |

## 3. Core API List

### 3.1. Connect SSE

Used for the SDK to connect to the Server and receive real-time events using the SSE protocol.

*   **Request URL**: `/server/v1/sse`
*   **Request Method**: `GET`
*   **Request Parameters**: None
*   **Response Parameters**:
    ```json
    {
        "apiCode": 1000,
        "message": "Connection successful",
        "data": {
            "action": "connected",
            "sessionId": "258cf6cb-0859-4743-81d4-716121efe886"
        }
    }
    ```
    | Parameter   | Type     | Remarks                                 |
    | :---------- | :------- |:----------------------------------------|
    | `apiCode`   | `int`    | `10000`: Success, `50000`: Internal business exception |
    | `message`   | `varchar`| Connection successful                   |
    | `data`      | `object` | Current `sessionId`                     |

---

### 3.2. Ping Packet

The server periodically sends Ping packet events to the SDK to maintain and check the connection status. The client subscribes to this event.

*   **Request Parameters**: `{"ping":"keep-alive"}`
*   **Response Parameters**: None

---

### 3.3. Connection Success Event

After the SDK successfully connects to the Server, the Server returns the current connection information. The client needs to subscribe to this event.

*   **Request Parameters**: None
*   **Response Parameters**:
    ```json
    {"apiCode":10000,"message":"Connection successful","data":{"action":"connected","sessionId":"162a4e39-6fce-4761-977b-a67e57a32ed3"}}
    ```

---

### 3.4. Thought Process Message Event

After the SDK calls the Server's business interface, the Server sends the entire thought process to the client via SSE.

*   **Request Parameters**: None
*   **Response Parameters**:
    ```json
    {
        "taskId": "b9c2d2b7-eae0-4d37-a86e-b8606a74ffb4",
        "action": "message",
        "params": "",
        "message": "Generating thought process"
    }
    ```

---

### 3.5. Convert Natural Language to Browser Instruction Message Event

After the SDK calls the Server's task initiation interface, the Server sends the process of converting natural language to browser instructions to the client via SSE.

*   **Request Parameters**: None
*   **Response Parameters**:
    ```json
    {
        "taskId": "b9c2d2b7-eae0-4d37-a86e-b8606a74ffb4",
        "action": "message",
        "params": "",
        "message": "Converting natural language to browser instructions"
    }
    ```

---

### 3.6. Browser Instruction Message Event

After the SDK calls the Server's task initiation interface, the Server sends the browser instruction process to the client via SSE.

*   **Request Parameters**: None
*   **Response Parameters**:
    ```json
    {
        "taskId": "b9c2d2b7-eae0-4d37-a86e-b8606a74ffb4",
        "action": "browser_event",
        "params": "{\"actions\":[{\"method\":\"navigate\",\"selector\":\"\",\"value\":\"https://twitter.com\",\"options\":null},{\"method\":\"wait\",\"selector\":\"input[data-testid='SearchBox_Search_Input']\",\"value\":\"\",\"options\":{\"timeout\":\"5s\"}},{\"method\":\"insertText\",\"selector\":\"input[data-testid='SearchBox_Search_Input']\",\"value\":\"Latest news about Musk\",\"options\":null},{\"method\":\"click\",\"selector\":\"div[data-testid='tweet'] div[aria-label='Reply']\",\"value\":\"\",\"options\":null},{\"method\":\"wait\",\"selector\":\"div[data-testid='tweetTextarea_0']\",\"value\":\"\",\"options\":{\"timeout\":\"5s\"}},{\"method\":\"insertText\",\"selector\":\"div[data-testid='tweetTextarea_0']\",\"value\":\"Comment\",\"options\":null},{\"method\":\"click\",\"selector\":\"div[data-testid='tweetButton']\",\"value\":\"\",\"options\":null}]} ",
        "message": "Browser instructions generated"
    }
    ```

---

### 3.7. Start Task Interface

Used to initiate an automation task.

*   **Request URL**: `/server/v1/task/start`
*   **Request Method**: `POST`
*   **Request Parameters**:

    | Parameter        | Type      | Remarks                  |
    | :-------------- | :-------- |:------------------------|
    | `sessionId`     | `varchar` | Connection ID            |
    | `tenantId`      | `varchar` | Tenant pool ID           |
    | `text`          | `varchar` | User's original Query data |
    | `genAuthUserId` | `varchar` | Current logged-in GenAuth user ID |
    | `type`          | `varchar` | `task`, initiate task    |
    | `browserId`     | `varchar` | Browser context ID       |
*   **Request Example**:
    ```json
    {"sessionId":"162a4e39-6fce-4761-977b-a67e57a32ed3","text":"Open Twitter, search for the latest news about Musk, and comment","type":"task","genAuthUserId":"xxxx"}
    ```
*   **Response Example**:
    ```json
    {
        "apiCode": 10000,
        "message": "Success",
        "data": {
            "taskId": "5b5eca40-d9db-42c5-8559-f0db606d8e53",
            "action": "message",
            "otherData": "",
            "message": "Conversation task initiated successfully"
        }
    }
    ```

---

### 3.8. Check if Browser Data Requires Login (Server to SDK)

After the server responds with browser instructions to the client, it issues a screenshot instruction to determine if login is required.

*   **Request Parameters**: None
*   **Request Method**: `POST` (Note: This method may not match the description in the "Business Event List" above; this event is pushed by the server, not actively requested by the SDK)
*   **Response Parameters**:
    ```json
    {
        "taskId": "b9c2d2b7-eae0-4d37-a86e-b8606a74ffb4",
        "action": "screenshot",
        "params": "",
        "message": "Capture the current browser page and report"
    }
    ```

---

### 3.9. Screenshot Reporting Interface (SDK to Server)

The SDK uploads the current screenshot to the server to determine whether login or registration is required. If needed, the server responds with the corresponding operation code, and the SDK needs to call the corresponding interface.

*   **Request URL**: `/server/v1/task/create-screenshot`
*   **Request Method**: `POST`
*   **Request Type**: `form-data`
*   **Request Parameters**:
* 
    | Parameter        | Type      | Remarks                         |
    | :-------------- | :-------- | :------------------------------ |
    | `sessionId`     | `varchar` | Connection ID                   |
    | `taskId`        | `varchar` | Task ID                         |
    | `screenshot`    | `file`    | Image file                      |
    | `url`           | `varchar` | Current browser address         |
    | `tenantId`      | `varchar` | Tenant pool ID                  |
    | `genAuthUserId` | `varchar` | IDaaS user ID                   |
*   **Response Content**:
    ```json
    {
        "apiCode": 10000,
        "message": "Success",
        "data": {
            "current_page": "login/register/human_machine/none",
            "application_name": "Xiaohongshu",
            "login_step": "click_code/click_next/click_code/submit/none",
            "switch_page": "none/click_switch_phone/click_switch_email",
            "login_type": "phone+code/email+p/u+p/email+code/phone+code/email/phone/none",
            "human_machine": "none/recaptcha/hcaptcha/funcaptcha",
            "app_id": "0o9s98de-f2f5-49a1-8a84-e15bab519cbc",
            "country":"china/other"
        }
    }
    ```

---

### 3.10. Client Get Application URL Interface (SDK to Server)

If the SDK finds that the current page requires login, it calls this interface to get the application login and registration URLs, which are used in the login, registration, and visual HTML retrieval interfaces.

*   **Request URL**: `/server/v1/client/urls`
*   **Request Method**: `POST`
*   **Request Parameters**:
* 
    | Parameter          | Type      | Remarks                         |
    | :---------------- | :-------- | :------------------------------ |
    | `applicationName` | `varchar` | Application name                |
    | `tenantId`        | `varchar` | Tenant pool ID                  |
*   **Response Content**:
    ```json
    {
        "apiCode": 10000,
        "message": "Success",
        "data": {
            "registration_Url": "https://www.facebook.com/r.php",
            "login_url": "https://www.facebook.com/login/",
            "success": true
        }
    }
    ```

---

### 3.11. Client Login Interface (SDK to Server)

If the SDK uploads a screenshot to the server and finds that login is required, it needs to call the login interface.

*   **Request URL**: `/server/v1/client/login`
*   **Request Method**: `POST`
*   **Request Parameters**:
* 
    | Parameter        | Type      | Remarks                             |
    | :-------------- | :-------- |:------------------------------------|
    | `sessionId`     | `varchar` | Connection ID                       |
    | `taskId`        | `varchar` | Task ID                             |
    | `applicationName` | `varchar` | Application name                    |
    | `appId`         | `varchar` | Application ID                      |
    | `loginUrl`      | `varchar` | Application address                  |
    | `html`          | `varchar` | Current page visible HTML or HTML with hidden values |
    | `genAuthUserId` | `varchar` | Current IDaaS user ID               |
    | `tenantId`      | `varchar` | Tenant pool ID                      |
    | `processEvent`  | `object`  | Current process event, see example below |
*   **`processEvent` Example**:
    ```json
    {
        "current_page": "login",
        "application_name": "Xiaohongshu",
        "login_step": "click_code",
        "switch_page": "none",
        "login_type": "phone+code",
        "human_machine": "none"
    }
    ```
*   **Response Content**:
    ```json
    {
        "apiCode": 10000,
        "message": "Success",
        "data": {
            "actions": [
                {
                    "method": "wait",
                    "selector": "#username",
                    "value": "",
                    "options": {
                        "timeout": "10s"
                    }
                },
                {
                    "method": "insertText",
                    "selector": "#username",
                    "value": "zhangsan",
                    "options": null
                },
                {
                    "method": "wait",
                    "selector": "#password",
                    "value": "",
                    "options": {
                        "timeout": "10s"
                    }
                },
                {
                    "method": "insertText",
                    "selector": "#password",
                    "value": "123456",
                    "options": null
                },
                {
                    "method": "click",
                    "selector": "#loginButton",
                    "value": "",
                    "options": null
                }
            ]
        }
    }
    ```

---

### 3.12. Client Registration Interface (SDK to Server)

If the SDK uploads a screenshot to the server and finds that registration is required, it needs to call the registration interface.

*   **Request URL**: `/server/v1/client/register`
*   **Request Method**: `POST`
*   **Request Parameters**:
* 
    | Parameter        | Type      | Remarks                         |
    | :-------------- | :-------- | :------------------------------ |
    | `sessionId`     | `varchar` | Connection ID                   |
    | `taskId`        | `varchar` | Task ID                         |
    | `applicationName` | `varchar` | Application name                |
    | `registerUrl`   | `varchar` | Application registration address |
    | `html`          | `varchar` | Current page visible HTML, only pass the visible HTML, needs to be obtained by the client |
    | `genAuthUserId` | `varchar` | Current IDaaS user ID           |
    | `tenantId`      | `varchar` | Tenant pool ID                  |
*   **Response Content**:
    ```json
    {
        "apiCode": 10000,
        "message": "Success",
        "data": {
            "actions": [
                {
                    "method": "wait",
                    "selector": "input[name='name']",
                    "value": "",
                    "options": {
                        "timeout": "1000"
                    }
                },
                {
                    "method": "insertText",
                    "selector": "input[name='name']",
                    "value": "jackdu",
                    "options": null
                },
                {
                    "method": "wait",
                    "selector": "input[name='phone_number']",
                    "value": "",
                    "options": {
                        "timeout": "1000"
                    }
                },
                {
                    "method": "insertText",
                    "selector": "input[name='phone_number']",
                    "value": "15001222222",
                    "options": null
                },
                {
                    "method": "click",
                    "selector": "button[type='button']",
                    "value": "",
                    "options": null
                },
                {
                    "method": "wait",
                    "selector": "select[id='SELECTOR_1']",
                    "value": "",
                    "options": {
                        "timeout": "1000"
                    }
                },
                {
                    "method": "select",
                    "selector": "select[id='SELECTOR_1']",
                    "value": "1",
                    "options": null
                },
                {
                    "method": "wait",
                    "selector": "select[id='SELECTOR_2']",
                    "value": "",
                    "options": {
                        "timeout": "1000"
                    }
                },
                {
                    "method": "select",
                    "selector": "select[id='SELECTOR_2']",
                    "value": "1",
                    "options": null
                },
                {
                    "method": "wait",
                    "selector": "select[id='SELECTOR_3']",
                    "value": "",
                    "options": {
                        "timeout": "1000"
                    }
                },
                {
                    "method": "select",
                    "selector": "select[id='SELECTOR_3']",
                    "value": "1990",
                    "options": null
                },
                {
                    "method": "wait",
                    "selector": "button[data-testid='ocfSignupNextLink']",
                    "value": "",
                    "options": {
                        "timeout": "1000"
                    }
                },
                {
                    "method": "click",
                    "selector": "button[data-testid='ocfSignupNextLink']",
                    "value": "",
                    "options": null
                }
            ]
        }
    }
    ```

---

### 3.13. Break CAPTCHA Interface (SDK to Server)

If the SDK finds that the screenshot upload response data indicates a CAPTCHA, it needs to call this interface.

*   **Request URL**: `/server/v1/client/machine`
*   **Request Method**: `POST`
*   **Request Parameters**:
* 
    | Parameter      | Type      | Remarks                                                         |
    | :------------- | :-------- | :-------------------------------------------------------------- |
    | `sessionId`    | `varchar` | Connection ID                                                   |
    | `taskId`       | `varchar` | Task ID                                                         |
    | `machineType`  | `varchar` | CAPTCHA type: `reCaptcha v2`/`hCaptcha`/`funCaptcha`/`cloudflare`/`textCaptcha`/`normal captcha`/`none` |
    | `machineData`  | `varchar` | CAPTCHA data, JSON string, format depends on `machineType`, see examples below |
    | `genAuthUserId`| `varchar` | Current IDaaS user ID                                           |
    | `tenantId`     | `varchar` | Tenant pool ID                                                  |
*   **`machineData` Examples**:
    *   **reCaptcha v2 CAPTCHA data**:
        ```json
        {
            "siteKey":"6LdktRgnAAAAAFQ6icovYI2-masYLFjEFyzQzpix",
            "url":"https://www.fbsbx.com/captcha/recaptcha/iframe/?__cci=ig_captcha_iframe&compact=false&locale=zh_CN&referer=https%253A%252F%252Fwww.instagram.com"
        }
        ```
    *   **hCaptcha CAPTCHA data**:
        ```json
        {
            "siteKey":"6LdktRgnAAAAAFQ6icovYI2-masYLFjEFyzQzpix",
            "url":"https://www.fbsbx.com/captcha/recaptcha/iframe/?__cci=ig_captcha_iframe&compact=false&locale=zh_CN&referer=https%253A%252F%252Fwww.instagram.com"
        }
        ```
    *   **funCaptcha CAPTCHA data**:
        ```json
        {
            "siteKey":"6LdktRgnAAAAAFQ6icovYI2-masYLFjEFyzQzpix",
            "url":"https://www.fbsbx.com/captcha/recaptcha/iframe/?__cci=ig_captcha_iframe&compact=false&locale=zh_CN&referer=https%253A%252F%252Fwww.instagram.com",
            "surl":"",
            "userAgent":"",
            "data":{"":""}
        }
        ```
    *   **normal captcha CAPTCHA data**:
        ```json
        {
            "file":"img.jpg",
            "base64":"",
            "phrase":"",
            "caseSensitive":"",
            "calc":"",
            "numberic":"",
            "minLen":"",
            "maxLen":"",
            "lang":"",
            "hintText":"",
            "hintImageBase64":"",
            "hintImageFile":""
        }
        ```
    *   **cloudflare CAPTCHA data**:
        ```json
        {
            "siteKey":"0x4AAAAAAAJel0iaAR3mgkjp",
            "url":"https://dash.cloudflare.com/login"
        }
        ```
*   **Response Content**:
    ```json
    {
        "apiCode": 10000,
        "message": "Success",
        "data": {
            "token": "03AFcWeA...",
            "id": "80061008118"
        }
    }
    ```
## 4. Constant Data Description
### 4.1. Ping Packet Response Data Constants
    | Parameter   | Value         | Remarks                                     |
    | :---------- | :------------ | :------------------------------------------ |
    | `ping`      | `keep-alive`  | Session keep-alive and detection            |
### 4.1. Screenshot Reporting Interface Response Data Constants
    | Parameter           | Value                                             | Remarks                                     |
    | :----------------- | :------------------------------------------------ | :------------------------------------------ |
| `current_page`      | `login` `register` `human_machine` `none`           | Current page type, e.g., login, register, CAPTCHA page, etc. |
| `application_name`  | `Facebook`                                          | Current application name, e.g., Facebook or Twitter |
| `login_step`        | `click_login` `click_next` `click_code` `submit` `none` | Current login step, e.g., click login button, click next, click get code, submit login, etc. |
| `switch_page`       | `click_switch_phone` `click_switch_email` `none`    | Whether to switch pages, e.g., switch to phone login, switch to email login, etc. |
| `login_type`        | `u+p` `email+p` `email+code` `phone+code` `email` `phone` `none` | Login type, e.g., username and password login, email and password login, email and code login, phone and code login, email login, phone login, etc. |
| `human_machine`     | `reCaptcha v2` `hCaptcha` `funCaptcha` `cloudflare` `textCaptcha` `normal captcha` `none` | Various CAPTCHA types |
| `country`           | `china` `other`                                     | Country of the current application, China or other |
